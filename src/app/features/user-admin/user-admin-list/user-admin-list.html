<div class="user-admin-page">
  <div class="page-header">
    <h1 class="page-title">{{ 'userAdmin.title' | translate }}</h1>
    @if (canManage) {
      <button mat-flat-button color="primary" (click)="openCreate()">
        <mat-icon>person_add</mat-icon>
        {{ 'userAdmin.create' | translate }}
      </button>
    }
  </div>

  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-row">
        <mat-form-field class="search-field" appearance="outline">
          <mat-label>{{ 'common.search' | translate }}</mat-label>
          <input matInput [value]="search" (input)="onSearchInput($any($event.target).value)">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>

        <mat-form-field class="filter-field" appearance="outline">
          <mat-label>{{ 'userAdmin.role' | translate }}</mat-label>
          <mat-select [(value)]="roleFilter" (selectionChange)="onFilterChange()">
            <mat-option value="">{{ 'common.all' | translate }}</mat-option>
            @for (role of assignableRoles; track role) {
              <mat-option [value]="role">{{ 'userAdmin.role.' + role | translate }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  @if (loading()) {
    <sgc-loading-spinner />
  } @else {
    <mat-card class="table-card">
      @if (users().length === 0) {
        <div class="no-data">
          <mat-icon>people_outline</mat-icon>
          <span>{{ 'userAdmin.noUsers' | translate }}</span>
        </div>
      } @else {
        <table mat-table [dataSource]="users()">
          <!-- Username -->
          <ng-container matColumnDef="username">
            <th mat-header-cell *matHeaderCellDef>{{ 'userAdmin.username' | translate }}</th>
            <td mat-cell *matCellDef="let user">
              <span class="username-cell" (click)="openDetail(user)">{{ user.username }}</span>
            </td>
          </ng-container>

          <!-- Name -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>{{ 'userAdmin.name' | translate }}</th>
            <td mat-cell *matCellDef="let user">
              {{ (user.firstName ?? '') + ' ' + (user.lastName ?? '') }}
            </td>
          </ng-container>

          <!-- Email -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>{{ 'userAdmin.email' | translate }}</th>
            <td mat-cell *matCellDef="let user">
              <span class="mono">{{ user.email ?? 'â€”' }}</span>
              @if (user.emailVerified) {
                <mat-icon class="verified-icon" inline>verified</mat-icon>
              }
            </td>
          </ng-container>

          <!-- Roles -->
          <ng-container matColumnDef="roles">
            <th mat-header-cell *matHeaderCellDef>{{ 'userAdmin.roles' | translate }}</th>
            <td mat-cell *matCellDef="let user">
              <div class="role-chips">
                @for (role of user.roles; track role) {
                  @if (assignableRoles.includes(role)) {
                    <span class="role-chip" [style.background-color]="getRoleColor(role)">
                      <mat-icon inline>{{ getRoleIcon(role) }}</mat-icon>
                      {{ role }}
                    </span>
                  }
                }
              </div>
            </td>
          </ng-container>

          <!-- Enabled -->
          <ng-container matColumnDef="enabled">
            <th mat-header-cell *matHeaderCellDef>{{ 'userAdmin.status' | translate }}</th>
            <td mat-cell *matCellDef="let user">
              <span class="status-indicator" [class.active]="user.enabled" [class.inactive]="!user.enabled">
                {{ user.enabled ? ('userAdmin.active' | translate) : ('userAdmin.inactive' | translate) }}
              </span>
            </td>
          </ng-container>

          <!-- Created -->
          <ng-container matColumnDef="created">
            <th mat-header-cell *matHeaderCellDef>{{ 'userAdmin.created' | translate }}</th>
            <td mat-cell *matCellDef="let user">
              {{ user.createdTimestamp | date:'dd/MM/yyyy' }}
            </td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let user">
              @if (canManage) {
                <button mat-icon-button [matMenuTriggerFor]="actionMenu"
                        [attr.aria-label]="'Actions for ' + user.username">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #actionMenu="matMenu">
                  <button mat-menu-item (click)="openDetail(user)">
                    <mat-icon>visibility</mat-icon>
                    <span>{{ 'common.view' | translate }}</span>
                  </button>
                  <button mat-menu-item (click)="openEdit(user)">
                    <mat-icon>edit</mat-icon>
                    <span>{{ 'common.edit' | translate }}</span>
                  </button>
                  <button mat-menu-item (click)="toggleEnabled(user)">
                    <mat-icon>{{ user.enabled ? 'block' : 'check_circle' }}</mat-icon>
                    <span>{{ user.enabled ? ('userAdmin.disable' | translate) : ('userAdmin.enable' | translate) }}</span>
                  </button>
                  @if (isAdmin) {
                    <button mat-menu-item class="delete-action" (click)="deleteUser(user)">
                      <mat-icon>delete</mat-icon>
                      <span>{{ 'common.delete' | translate }}</span>
                    </button>
                  }
                </mat-menu>
              }
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns" class="clickable-row"
              tabindex="0" role="link" [attr.aria-label]="'View details for ' + row.username"
              (click)="openDetail(row)" (keydown.enter)="openDetail(row)"></tr>
        </table>

        <mat-paginator
          [length]="totalElements()"
          [pageIndex]="page"
          [pageSize]="pageSize"
          [pageSizeOptions]="[10, 20, 50]"
          (page)="onPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      }
    </mat-card>
  }
</div>
